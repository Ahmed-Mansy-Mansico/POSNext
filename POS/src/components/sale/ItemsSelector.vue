<template>
	<div class="flex flex-col h-full bg-gray-50">
		<!-- Item Groups Filter Tabs -->
		<div class="px-1.5 sm:px-3 pt-1.5 sm:pt-3 pb-1.5 sm:pb-2 bg-white border-b border-gray-200">
			<div class="flex items-center space-x-1 sm:space-x-2 overflow-x-auto pb-1 scrollbar-hide snap-x snap-mandatory">
				<button
					@click="itemStore.setSelectedItemGroup(null)"
					:class="[
						'flex items-center space-x-1 sm:space-x-1.5 px-2 sm:px-3 py-1.5 sm:py-2 rounded-lg text-[10px] sm:text-xs font-medium whitespace-nowrap transition-[background-color,border-color] duration-75 touch-manipulation snap-start flex-shrink-0',
						!selectedItemGroup
							? 'bg-blue-50 text-blue-600 border-2 border-blue-500 shadow-sm'
							: 'bg-white text-gray-700 border border-gray-200 hover:bg-gray-50 active:bg-gray-100',
					]"
				>
					<svg class="w-3.5 h-3.5 sm:w-4 sm:h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
						<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/>
					</svg>
					<span>All Items</span>
				</button>
				<button
					v-for="group in itemGroups"
					:key="group.item_group"
					@click="itemStore.setSelectedItemGroup(group.item_group)"
					:class="[
						'flex items-center space-x-1 sm:space-x-1.5 px-2 sm:px-3 py-1.5 sm:py-2 rounded-lg text-[10px] sm:text-xs font-medium whitespace-nowrap transition-[background-color,border-color] duration-75 touch-manipulation snap-start flex-shrink-0',
						selectedItemGroup === group.item_group
							? 'bg-blue-50 text-blue-600 border-2 border-blue-500 shadow-sm'
							: 'bg-white text-gray-700 border border-gray-200 hover:bg-gray-50 active:bg-gray-100',
					]"
				>
					<span>{{ group.item_group }}</span>
				</button>
			</div>
		</div>

		<!-- Cache Sync Indicator -->
		<div v-if="cacheSyncing" class="px-1.5 sm:px-3 py-1 bg-blue-50 border-b border-blue-200">
			<div class="flex items-center justify-center space-x-2 text-[10px] sm:text-xs text-blue-700">
				<div class="animate-spin rounded-full h-3 w-3 border-b-2 border-blue-600"></div>
				<span>Syncing catalog in background... {{ cacheStats.items }} items cached</span>
			</div>
		</div>

		<!-- Search Bar with Barcode Scanner and View Controls -->
		<div class="px-1.5 sm:px-3 py-1.5 sm:py-2 bg-white border-b border-gray-200">
			<div class="flex items-center space-x-1 sm:space-x-2">
				<div class="flex-1 relative min-w-0">
					<!-- Search Icon -->
					<div class="absolute inset-y-0 left-0 pl-2 sm:pl-3 flex items-center pointer-events-none">
						<svg
							class="h-3.5 w-3.5 sm:h-4 sm:w-4 text-gray-400"
							fill="none"
							stroke="currentColor"
							viewBox="0 0 24 24"
						>
							<path
								stroke-linecap="round"
								stroke-linejoin="round"
								stroke-width="2"
								d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"
							/>
						</svg>
					</div>
					<!-- Search Input -->
					<input
						id="item-search"
						name="item-search"
						ref="searchInputRef"
						:value="searchTerm"
						@input="handleSearchInput"
						@keydown="handleKeyDown"
						type="text"
						:placeholder="searchPlaceholder"
						:class="[
							'w-full text-[11px] sm:text-sm border rounded-lg px-2 sm:px-3 py-2 pl-7 sm:pl-10 pr-16 sm:pr-24 focus:outline-none transition-all',
							autoAddEnabled
								? 'border-blue-400 bg-blue-50 focus:ring-2 focus:ring-blue-500 focus:border-transparent'
								: scannerEnabled
								? 'border-green-400 bg-green-50 focus:ring-2 focus:ring-green-500 focus:border-transparent'
								: 'border-gray-300 focus:ring-2 focus:ring-blue-500 focus:border-transparent'
						]"
						aria-label="Search items"
					/>
					<!-- Barcode Scan Icon and Auto-Add Toggle -->
					<div class="absolute inset-y-0 right-0 pr-1 sm:pr-2 flex items-center gap-0.5">
						<button
							@click="toggleBarcodeScanner"
							:class="[
								'p-1 sm:p-1.5 rounded transition-[background-color] duration-75 touch-manipulation',
								scannerEnabled
									? 'bg-green-100 hover:bg-green-200 active:bg-green-300 text-green-700'
									: 'hover:bg-gray-100 active:bg-gray-200 text-gray-600'
							]"
							:title="scannerEnabled ? 'Barcode Scanner: ON (Click to disable)' : 'Barcode Scanner: OFF (Click to enable)'"
							:aria-label="scannerEnabled ? 'Disable barcode scanner' : 'Enable barcode scanner'"
						>
							<svg class="w-3.5 h-3.5 sm:w-4 sm:h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
								<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v1m6 11h2m-6 0h-2v4m0-11v3m0 0h.01M12 12h4.01M16 20h4M4 12h4m12 0h.01M5 8h2a1 1 0 001-1V5a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1zm12 0h2a1 1 0 001-1V5a1 1 0 00-1-1h-2a1 1 0 00-1 1v2a1 1 0 001 1zM5 20h2a1 1 0 001-1v-2a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1z"/>
							</svg>
						</button>
						<button
							@click="toggleAutoAdd"
							:class="[
								'p-1 sm:p-1.5 rounded transition-[background-color] duration-75 flex items-center gap-0.5 text-[9px] sm:text-xs font-medium px-1 sm:px-2 touch-manipulation',
								autoAddEnabled
									? 'bg-blue-100 hover:bg-blue-200 active:bg-blue-300 text-blue-700'
									: 'hover:bg-gray-100 active:bg-gray-200 text-gray-600'
							]"
							:title="autoAddEnabled ? 'Auto-Add: ON - Press Enter to add items to cart' : 'Auto-Add: OFF - Click to enable automatic cart addition on Enter'"
							:aria-label="autoAddEnabled ? 'Disable auto-add' : 'Enable auto-add'"
						>
							<svg class="w-3 h-3 sm:w-3.5 sm:h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
								<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
							</svg>
							<span class="hidden xs:inline">Auto</span>
						</button>
					</div>
				</div>
				<div class="flex items-center space-x-0.5 bg-gray-100 rounded-lg p-0.5 flex-shrink-0">
					<button
						@click="setViewMode('grid')"
						:class="[
							'p-1.5 sm:p-2 rounded transition-[background-color,box-shadow] duration-75 touch-manipulation',
							viewMode === 'grid' ? 'bg-white shadow-sm' : 'hover:bg-gray-200 active:bg-gray-300'
						]"
						title="Grid View"
						:aria-label="'Switch to grid view'"
					>
						<svg class="w-4 h-4 sm:w-4.5 sm:h-4.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
							<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z"/>
						</svg>
					</button>
					<button
						@click="setViewMode('list')"
						:class="[
							'p-1.5 sm:p-2 rounded transition-[background-color,box-shadow] duration-75 touch-manipulation',
							viewMode === 'list' ? 'bg-white shadow-sm' : 'hover:bg-gray-200 active:bg-gray-300'
						]"
						title="List View"
						:aria-label="'Switch to list view'"
					>
						<svg class="w-4 h-4 sm:w-4.5 sm:h-4.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
							<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/>
						</svg>
					</button>
				</div>
			</div>
		</div>

		<!-- Loading State -->
		<div v-if="loading || searching" class="flex-1 flex items-center justify-center p-3">
			<div class="text-center py-8">
				<div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500 mx-auto"></div>
				<p class="mt-3 text-xs text-gray-500">{{ searching ? 'Searching all items...' : 'Loading items...' }}</p>
			</div>
		</div>

		<!-- Empty State -->
		<div
			v-else-if="!filteredItems || filteredItems.length === 0"
			class="flex-1 flex items-center justify-center p-3"
		>
			<div class="text-center py-8">
				<svg
					class="mx-auto h-8 w-8 text-gray-400"
					fill="none"
					stroke="currentColor"
					viewBox="0 0 24 24"
				>
					<path
						stroke-linecap="round"
						stroke-linejoin="round"
						stroke-width="2"
						d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"
					/>
				</svg>
				<p v-if="searchTerm || selectedItemGroup" class="mt-2 text-xs font-medium text-gray-700">
					No results for <span v-if="searchTerm">"{{ searchTerm }}"</span><span v-if="searchTerm && selectedItemGroup"> in </span><span v-if="selectedItemGroup">{{ selectedItemGroup }}</span>
				</p>
				<p v-else class="mt-2 text-xs text-gray-500">No items available</p>
			</div>
		</div>

		<!-- Grid View -->
		<div v-else-if="viewMode === 'grid'" class="flex-1 flex flex-col overflow-hidden">
			<div
				ref="gridScrollContainer"
				class="flex-1 overflow-y-auto p-1.5 sm:p-3"
			>
				<div class="grid grid-cols-2 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-1.5 sm:gap-2.5">
					<div
						v-for="item in paginatedItems"
						:key="item.item_code"
						v-memo="[item.item_code, item.actual_qty, item.stock_qty, item.rate, item.price_list_rate]"
						@touchstart.passive="getOptimizedClickHandler(item).touchstart"
						@touchmove.passive="getOptimizedClickHandler(item).touchmove"
						@touchend.passive="getOptimizedClickHandler(item).touchend"
						@click="getOptimizedClickHandler(item).click"
						class="relative bg-white border border-gray-200 rounded-lg p-1.5 sm:p-2.5 cursor-pointer hover:border-blue-400 hover:shadow-md transition-[border-color,box-shadow] duration-100 touch-manipulation"
					>
						<!-- Stock Badge - Positioned at top right of card -->
						<div
							:class="[
								'absolute -top-1.5 -right-1.5 sm:-top-2 sm:-right-2 rounded-md shadow-lg z-10',
								'px-2 sm:px-2.5 py-1 sm:py-1',
								'text-[10px] sm:text-xs font-bold',
								'border-2 border-white',
								getStockStatus(item.actual_qty || item.stock_qty).color,
								getStockStatus(item.actual_qty || item.stock_qty).textColor
							]"
							:title="`${getStockStatus(item.actual_qty || item.stock_qty).label}: ${Math.floor(item.actual_qty || item.stock_qty || 0)} ${item.uom || item.stock_uom || 'Nos'}`"
						>
							{{ Math.floor(item.actual_qty || item.stock_qty || 0) }}
						</div>

						<!-- Item Image -->
						<div class="relative aspect-square bg-gray-100 rounded-md mb-1.5 sm:mb-2 overflow-hidden">
							<LazyImage
								v-if="item.image"
								:src="item.image"
								:alt="item.item_name"
								container-class="relative w-full h-full"
								img-class="w-full h-full object-cover"
								root-margin="100px"
							>
								<template #error>
									<svg
										class="h-8 w-8 sm:h-10 sm:w-10 text-gray-300"
										fill="none"
										stroke="currentColor"
										viewBox="0 0 24 24"
									>
										<path
											stroke-linecap="round"
											stroke-linejoin="round"
											stroke-width="2"
											d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"
										/>
									</svg>
								</template>
							</LazyImage>
							<div v-else class="w-full h-full flex items-center justify-center">
								<svg
									class="h-8 w-8 sm:h-10 sm:w-10 text-gray-300"
									fill="none"
									stroke="currentColor"
									viewBox="0 0 24 24"
								>
									<path
										stroke-linecap="round"
										stroke-linejoin="round"
										stroke-width="2"
										d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"
									/>
								</svg>
							</div>
						</div>

						<!-- Item Details -->
						<div class="min-w-0">
							<h3 class="text-[10px] sm:text-xs font-semibold text-gray-900 truncate mb-0.5 leading-tight">
								{{ item.item_name }}
							</h3>
                                                        <p class="text-[9px] sm:text-[10px] text-gray-500 leading-tight">
                                                                <span class="font-semibold text-blue-600">{{ formatCurrency(item.rate || item.price_list_rate || 0) }}</span>
                                                                <span class="text-gray-400">/ {{ item.uom || item.stock_uom || 'Nos' }}</span>
                                                        </p>
						</div>
					</div>
				</div>

				<!-- Loading More Indicator for Grid View -->
				<div v-if="loadingMore" class="flex justify-center items-center py-4">
					<div class="animate-spin rounded-full h-6 w-6 border-b-2 border-blue-500"></div>
					<p class="ml-2 text-xs text-gray-500">Loading more items...</p>
				</div>

				<!-- End of Results Indicator - Only show when browsing (not searching) -->
				<div v-else-if="!hasMore && filteredItems.length > 0 && !searchTerm" class="flex justify-center items-center py-3">
					<p class="text-xs text-gray-400">All items loaded</p>
				</div>

				<!-- Search Results Count -->
				<div v-else-if="searchTerm && filteredItems.length > 0" class="flex justify-center items-center py-3">
					<p class="text-xs text-gray-500">{{ filteredItems.length }} items found</p>
				</div>
			</div>

			<!-- Pagination Controls for Grid View -->
			<div v-if="totalPages > 1" class="px-2 sm:px-3 py-2 bg-white border-t border-gray-200">
				<div class="flex flex-col sm:flex-row items-center justify-between gap-2">
					<div class="text-[10px] sm:text-xs text-gray-600 order-2 sm:order-1">
						{{ ((currentPage - 1) * itemsPerPage) + 1 }}-{{ Math.min(currentPage * itemsPerPage, filteredItems.length) }} of {{ filteredItems.length }}
					</div>
					<div class="flex items-center space-x-1 order-1 sm:order-2">
						<button
							@click="previousPage"
							:disabled="currentPage === 1"
							:class="[
								'px-2 sm:px-3 py-1.5 text-[10px] sm:text-xs font-medium rounded-lg border transition-[background-color] duration-75 touch-manipulation',
								currentPage === 1
									? 'bg-gray-100 text-gray-400 border-gray-200 cursor-not-allowed'
									: 'bg-white text-gray-700 border-gray-300 hover:bg-gray-50 active:bg-gray-100'
							]"
							:aria-label="'Go to previous page'"
						>
							<span class="hidden xs:inline">Previous</span>
							<span class="xs:hidden">‹</span>
						</button>
						<div class="flex items-center space-x-0.5 sm:space-x-1">
							<button
								v-for="page in getPaginationRange()"
								:key="page"
								@click="goToPage(page)"
								:class="[
									'min-w-[28px] sm:min-w-[32px] px-1.5 sm:px-2.5 py-1.5 text-[10px] sm:text-xs font-medium rounded-lg border transition-[background-color,border-color] duration-75 touch-manipulation',
									currentPage === page
										? 'bg-blue-600 text-white border-blue-600'
										: 'bg-white text-gray-700 border-gray-300 hover:bg-gray-50 active:bg-gray-100'
								]"
								:aria-label="'Go to page ' + page"
							>
								{{ page }}
							</button>
						</div>
						<button
							@click="nextPage"
							:disabled="currentPage === totalPages"
							:class="[
								'px-2 sm:px-3 py-1.5 text-[10px] sm:text-xs font-medium rounded-lg border transition-[background-color] duration-75 touch-manipulation',
								currentPage === totalPages
									? 'bg-gray-100 text-gray-400 border-gray-200 cursor-not-allowed'
									: 'bg-white text-gray-700 border-gray-300 hover:bg-gray-50 active:bg-gray-100'
							]"
							:aria-label="'Go to next page'"
						>
							<span class="hidden xs:inline">Next</span>
							<span class="xs:hidden">›</span>
						</button>
					</div>
				</div>
			</div>
		</div>

		<!-- Table View -->
		<div v-else class="flex-1 flex flex-col overflow-hidden">
			<div
				ref="listScrollContainer"
				class="flex-1 overflow-x-auto overflow-y-auto"
			>
				<table class="min-w-full divide-y divide-gray-200">
					<thead class="bg-gray-50 sticky top-0 z-0">
						<tr>
							<th scope="col" class="px-2 sm:px-3 py-2 sm:py-2.5 text-left text-[10px] sm:text-xs font-semibold text-gray-700 uppercase tracking-wider bg-gray-50 border-b-2 border-gray-200">Image</th>
							<th scope="col" class="px-2 sm:px-3 py-2 sm:py-2.5 text-left text-[10px] sm:text-xs font-semibold text-gray-700 uppercase tracking-wider bg-gray-50 border-b-2 border-gray-200">Name</th>
							<th scope="col" class="hidden sm:table-cell px-2 sm:px-3 py-2 sm:py-2.5 text-left text-[10px] sm:text-xs font-semibold text-gray-700 uppercase tracking-wider bg-gray-50 border-b-2 border-gray-200">Code</th>
							<th scope="col" class="px-2 sm:px-3 py-2 sm:py-2.5 text-left text-[10px] sm:text-xs font-semibold text-gray-700 uppercase tracking-wider bg-gray-50 border-b-2 border-gray-200">Rate</th>
							<th scope="col" class="px-2 sm:px-3 py-2 sm:py-2.5 text-left text-[10px] sm:text-xs font-semibold text-gray-700 uppercase tracking-wider bg-gray-50 border-b-2 border-gray-200">Qty</th>
							<th scope="col" class="hidden md:table-cell px-2 sm:px-3 py-2 sm:py-2.5 text-left text-[10px] sm:text-xs font-semibold text-gray-700 uppercase tracking-wider bg-gray-50 border-b-2 border-gray-200">UOM</th>
						</tr>
					</thead>
					<tbody class="bg-white divide-y divide-gray-200">
						<tr
							v-for="item in paginatedItems"
							:key="item.item_code"
							v-memo="[item.item_code, item.actual_qty, item.stock_qty, item.rate, item.price_list_rate]"
							@click="handleItemClick(item)"
							class="cursor-pointer hover:bg-blue-50 transition-colors duration-100 touch-manipulation active:bg-blue-100"
						>
							<td class="px-2 sm:px-3 py-2 whitespace-nowrap">
								<div class="w-8 h-8 sm:w-10 sm:h-10 bg-gray-100 rounded flex items-center justify-center overflow-hidden">
									<LazyImage
										v-if="item.image"
										:src="item.image"
										:alt="item.item_name"
										container-class="relative w-full h-full"
										img-class="w-full h-full object-cover"
										root-margin="100px"
									>
										<template #error>
											<svg class="h-4 w-4 sm:h-5 sm:w-5 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
												<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
											</svg>
										</template>
									</LazyImage>
									<svg v-else class="h-4 w-4 sm:h-5 sm:w-5 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
										<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
									</svg>
								</div>
							</td>
							<td class="px-2 sm:px-3 py-2"><div class="text-xs sm:text-sm font-medium text-gray-900 truncate max-w-[150px] sm:max-w-none">{{ item.item_name }}</div></td>
							<td class="hidden sm:table-cell px-2 sm:px-3 py-2 whitespace-nowrap"><div class="text-xs sm:text-sm text-gray-500">{{ item.item_code }}</div></td>
							<td class="px-2 sm:px-3 py-2 whitespace-nowrap"><div class="text-xs sm:text-sm font-semibold text-blue-600">{{ formatCurrency(item.rate || item.price_list_rate || 0) }}</div></td>
							<td class="px-2 sm:px-3 py-2 whitespace-nowrap">
								<span
									:class="[
										'inline-block px-2.5 sm:px-3 py-1 sm:py-1.5 rounded-md shadow-sm',
										'text-xs sm:text-sm font-bold',
										getStockStatus(item.actual_qty || item.stock_qty).color,
										getStockStatus(item.actual_qty || item.stock_qty).textColor
									]"
									:title="`${getStockStatus(item.actual_qty || item.stock_qty).label}: ${Math.floor(item.actual_qty || item.stock_qty || 0)} ${item.uom || item.stock_uom || 'Nos'}`"
								>
									{{ Math.floor(item.actual_qty || item.stock_qty || 0) }}
								</span>
							</td>
                                                        <td class="hidden md:table-cell px-2 sm:px-3 py-2 whitespace-nowrap"><div class="text-xs sm:text-sm text-gray-500">{{ item.uom || item.stock_uom || 'Nos' }}</div></td>
						</tr>
					</tbody>
				</table>
				<div v-if="paginatedItems.length === 0" class="text-center py-8 text-gray-500">No items found</div>

				<!-- Loading More Indicator for Table View -->
				<div v-if="loadingMore" class="flex justify-center items-center py-4 bg-white">
					<div class="animate-spin rounded-full h-6 w-6 border-b-2 border-blue-500"></div>
					<p class="ml-2 text-xs text-gray-500">Loading more items...</p>
				</div>

				<!-- End of Results Indicator - Only show when browsing (not searching) -->
				<div v-else-if="!hasMore && filteredItems.length > 0 && !searchTerm" class="flex justify-center items-center py-3 bg-white">
					<p class="text-xs text-gray-400">All items loaded</p>
				</div>

				<!-- Search Results Count -->
				<div v-else-if="searchTerm && filteredItems.length > 0" class="flex justify-center items-center py-3 bg-white">
					<p class="text-xs text-gray-500">{{ filteredItems.length }} items found</p>
				</div>
			</div>

			<!-- Pagination Controls for List View -->
			<div v-if="totalPages > 1" class="px-2 sm:px-3 py-2 bg-white border-t border-gray-200">
				<div class="flex flex-col sm:flex-row items-center justify-between gap-2">
					<div class="text-[10px] sm:text-xs text-gray-600 order-2 sm:order-1">
						{{ ((currentPage - 1) * itemsPerPage) + 1 }}-{{ Math.min(currentPage * itemsPerPage, filteredItems.length) }} of {{ filteredItems.length }}
					</div>
					<div class="flex items-center space-x-1 order-1 sm:order-2">
						<button
							@click="previousPage"
							:disabled="currentPage === 1"
							:class="[
								'px-2 sm:px-3 py-1.5 text-[10px] sm:text-xs font-medium rounded-lg border transition-[background-color] duration-75 touch-manipulation',
								currentPage === 1
									? 'bg-gray-100 text-gray-400 border-gray-200 cursor-not-allowed'
									: 'bg-white text-gray-700 border-gray-300 hover:bg-gray-50 active:bg-gray-100'
							]"
							:aria-label="'Go to previous page'"
						>
							<span class="hidden xs:inline">Previous</span>
							<span class="xs:hidden">‹</span>
						</button>
						<div class="flex items-center space-x-0.5 sm:space-x-1">
							<button
								v-for="page in getPaginationRange()"
								:key="page"
								@click="goToPage(page)"
								:class="[
									'min-w-[28px] sm:min-w-[32px] px-1.5 sm:px-2.5 py-1.5 text-[10px] sm:text-xs font-medium rounded-lg border transition-[background-color,border-color] duration-75 touch-manipulation',
									currentPage === page
										? 'bg-blue-600 text-white border-blue-600'
										: 'bg-white text-gray-700 border-gray-300 hover:bg-gray-50 active:bg-gray-100'
								]"
								:aria-label="'Go to page ' + page"
							>
								{{ page }}
							</button>
						</div>
						<button
							@click="nextPage"
							:disabled="currentPage === totalPages"
							:class="[
								'px-2 sm:px-3 py-1.5 text-[10px] sm:text-xs font-medium rounded-lg border transition-[background-color] duration-75 touch-manipulation',
								currentPage === totalPages
									? 'bg-gray-100 text-gray-400 border-gray-200 cursor-not-allowed'
									: 'bg-white text-gray-700 border-gray-300 hover:bg-gray-50 active:bg-gray-100'
							]"
							:aria-label="'Go to next page'"
						>
							<span class="hidden xs:inline">Next</span>
							<span class="xs:hidden">›</span>
						</button>
					</div>
				</div>
			</div>
		</div>
	</div>
</template>

<script setup>
import LazyImage from "@/components/common/LazyImage.vue"
import { useItemSearchStore } from "@/stores/itemSearch"
import { formatCurrency as formatCurrencyUtil } from "@/utils/currency"
import { toast } from "frappe-ui"
import { storeToRefs } from "pinia"
import { computed, onMounted, onUnmounted, ref, watch } from "vue"
import {
	createOptimizedClickHandler,
	throttleRAF,
	addPassiveListener,
	runWhenIdle
} from "@/utils/lowEndOptimizations"

const props = defineProps({
	posProfile: String,
	cartItems: {
		type: Array,
		default: () => [],
	},
	currency: {
		type: String,
		default: "USD",
	},
})

const emit = defineEmits(["item-selected"])

// Use Pinia store
const itemStore = useItemSearchStore()
const {
	filteredItems,
	searchTerm,
	selectedItemGroup,
	itemGroups,
	loading,
	loadingMore,
	searching,
	hasMore,
	cacheReady,
	cacheSyncing,
	cacheStats,
} = storeToRefs(itemStore)

// Local state
const viewMode = ref("grid")
const lastKeyTime = ref(0)
const barcodeBuffer = ref("")
const searchInputRef = ref(null)
const scannerEnabled = ref(false)
const autoAddEnabled = ref(false)
const itemThreshold = ref(50) // Threshold for auto-switching to list view
const userManuallySetView = ref(false) // Track if user manually changed view mode
const scannerInputDetected = ref(false) // Track if current input is from scanner
const autoSearchTimer = ref(null) // Timer for auto-search when typing stops
const lastAutoSwitchCount = ref(0)
const lastFilterSignature = ref("")

// Infinite scroll refs
const gridScrollContainer = ref(null)
const listScrollContainer = ref(null)

// Pagination state (for client-side display)
const currentPage = ref(1)
const itemsPerPage = ref(20)

// Computed paginated items
const paginatedItems = computed(() => {
	if (!filteredItems.value) return []

	const start = (currentPage.value - 1) * itemsPerPage.value
	const end = start + itemsPerPage.value
	return filteredItems.value.slice(start, end)
})

const totalPages = computed(() => {
	if (!filteredItems.value) return 0
	return Math.ceil(filteredItems.value.length / itemsPerPage.value)
})

const SEARCH_PLACEHOLDERS = Object.freeze({
	auto: "Auto-Add ON - Type or scan barcode",
	scanner: "Scanner ON - Enable Auto for automatic addition",
	default: "Search by item code, name or scan barcode",
})

const searchMode = computed(() => {
	if (autoAddEnabled.value) {
		return "auto"
	}

	if (scannerEnabled.value) {
		return "scanner"
	}

	return "default"
})

const searchPlaceholder = computed(() => SEARCH_PLACEHOLDERS[searchMode.value])

// Watch for cart items and pos profile changes (optimized - uses length + hash instead of deep watch)
// Tracks: length, item_code, quantity, and amount to detect all cart changes including array replacements
watch(
	() =>
		`${props.cartItems.length}-${props.cartItems.map((i) => `${i.item_code}:${i.quantity || 0}:${i.amount || 0}`).join("|")}`,
	() => {
		itemStore.setCartItems(props.cartItems)
	},
	{ immediate: true },
)

watch(
	() => props.posProfile,
	(newProfile) => {
		if (newProfile) {
			itemStore.setPosProfile(newProfile)
		}
	},
	{ immediate: true },
)

// Reset to page 1 when filtered items meaningfully change
watch(
	filteredItems,
	(newItems) => {
		if (!newItems) return

		const itemCount = newItems.length
		const firstCode = itemCount > 0 ? newItems[0]?.item_code || "" : ""
		const lastCode =
			itemCount > 0 ? newItems[itemCount - 1]?.item_code || "" : ""
		const middleIndex = itemCount > 2 ? Math.floor(itemCount / 2) : -1
		const middleCode =
			middleIndex >= 0 ? newItems[middleIndex]?.item_code || "" : ""
		const signature = `${itemCount}|${firstCode}|${middleCode}|${lastCode}`

		if (signature !== lastFilterSignature.value) {
			currentPage.value = 1
			lastFilterSignature.value = signature
		}

		// Only auto-switch if user hasn't manually set a preference
		// and we're in grid view with many items
		if (
			!userManuallySetView.value &&
			viewMode.value === "grid" &&
			itemCount > itemThreshold.value
		) {
			if (lastAutoSwitchCount.value !== itemCount) {
				viewMode.value = "list"
				lastAutoSwitchCount.value = itemCount

				toast.create({
					title: "Switched to List View",
					text: `Displaying ${itemCount} items - automatically switched to list view for better performance`,
					icon: "list",
					iconClasses: "text-blue-600",
				})
			}
		} else if (itemCount <= itemThreshold.value) {
			lastAutoSwitchCount.value = 0
		}
	},
	{ immediate: false },
)

// Throttle scroll handler for better performance
let scrollTimeout = null
const SCROLL_THROTTLE_MS = 100

// Optimized scroll handler using RAF throttling
const handleScrollRAF = throttleRAF((event) => {
	const container = event.target
	const scrollPosition = container.scrollTop + container.clientHeight
	const scrollHeight = container.scrollHeight
	const threshold = 200

	const isSearching = searchTerm.value && searchTerm.value.trim().length > 0

	if (
		!isSearching &&
		scrollHeight - scrollPosition < threshold &&
		hasMore.value &&
		!loadingMore.value &&
		!loading.value
	) {
		// Use runWhenIdle to load more items without blocking scroll
		runWhenIdle(() => {
			itemStore.loadMoreItems()
		}, { timeout: 1000 })
	}
})

function handleScroll(event) {
	handleScrollRAF(event)
}

onMounted(() => {
	if (props.posProfile) {
		itemStore.loadAllItems(props.posProfile)
		itemStore.loadItemGroups()
	}

	// Add passive scroll listeners for better performance
	const cleanupFns = []

	if (gridScrollContainer.value) {
		const cleanup = addPassiveListener(
			gridScrollContainer.value,
			'scroll',
			handleScroll,
			{ passive: true }
		)
		cleanupFns.push(cleanup)
	}

	if (listScrollContainer.value) {
		const cleanup = addPassiveListener(
			listScrollContainer.value,
			'scroll',
			handleScroll,
			{ passive: true }
		)
		cleanupFns.push(cleanup)
	}

	// Store cleanup functions for onUnmounted
	window.__scrollCleanup = cleanupFns
})

onUnmounted(() => {
	// Cleanup background sync when component unmounts
	itemStore.cleanup()

	// Clear scroll timeout
	if (scrollTimeout) {
		clearTimeout(scrollTimeout)
		scrollTimeout = null
	}

	// Cleanup passive listeners
	if (window.__scrollCleanup) {
		window.__scrollCleanup.forEach(cleanup => cleanup())
		delete window.__scrollCleanup
	}

	// Clear optimized click handlers
	optimizedClickHandlers.clear()
})

// Handle keydown for barcode scanner detection
function handleKeyDown(event) {
	const currentTime = Date.now()
	const timeDiff = currentTime - lastKeyTime.value

	// If Enter/newline is pressed, trigger barcode search
	if (event.key === "Enter") {
		event.preventDefault()

		// Auto-add if Auto-Add mode is enabled (regardless of manual typing vs scanner)
		if (autoAddEnabled.value) {
			// Auto-add enabled - add item directly to cart
			handleBarcodeSearch(true) // Pass true to indicate auto-add
		} else {
			// Auto-add disabled - normal search behavior
			handleBarcodeSearch(false)
		}

		// Reset detection
		barcodeBuffer.value = ""
		scannerInputDetected.value = false

		// Clear auto-search timer since Enter was pressed
		if (autoSearchTimer.value) {
			clearTimeout(autoSearchTimer.value)
			autoSearchTimer.value = null
		}

		return
	}

	// Barcode scanners typically input very fast (< 50ms between characters)
	// If time between keystrokes is very short, it's likely a barcode scanner
	if (
		timeDiff < 50 &&
		event.key.length === 1 &&
		barcodeBuffer.value.length > 0
	) {
		barcodeBuffer.value += event.key
		scannerInputDetected.value = true // Mark as scanner input
	} else if (event.key.length === 1) {
		// Manual typing - reset buffer
		barcodeBuffer.value = event.key
		scannerInputDetected.value = false // Mark as manual input
	}

	lastKeyTime.value = currentTime
}

// Handle search input with instant reactivity
function handleSearchInput(event) {
	const value = event.target.value
	itemStore.setSearchTerm(value)

	// Clear any existing timer
	if (autoSearchTimer.value) {
		clearTimeout(autoSearchTimer.value)
		autoSearchTimer.value = null
	}

	// If Auto-Add is enabled and user is typing, automatically trigger search after they stop
	if (autoAddEnabled.value && value.trim().length > 0) {
		// Wait 500ms after user stops typing, then auto-search and add
		autoSearchTimer.value = setTimeout(() => {
			handleBarcodeSearch(true) // Auto-add mode
		}, 500) // 500ms delay after typing stops
	}
}

// Create optimized click handlers for better touch response
const optimizedClickHandlers = new Map()

function getOptimizedClickHandler(item) {
	const key = item.item_code
	if (!optimizedClickHandlers.has(key)) {
		const handler = createOptimizedClickHandler(() => {
			handleItemClick(item)
		}, {
			feedback: true,
			haptic: true
		})
		optimizedClickHandlers.set(key, handler)
	}
	return optimizedClickHandlers.get(key)
}

function handleItemClick(item) {
	emit("item-selected", item)
}

async function handleBarcodeSearch(forceAutoAdd = false) {
	const barcode = searchTerm.value.trim()

	if (!barcode) {
		return
	}

	// Auto-add if explicitly requested (from scanner newline detection)
	// OR if both scanner and auto-add modes are enabled
	const shouldAutoAdd =
		forceAutoAdd || (scannerEnabled.value && autoAddEnabled.value)

	try {
		// First try exact barcode lookup via API
		const item = await itemStore.searchByBarcode(barcode)

		if (item) {
			// Item found by barcode - add to cart immediately with auto-add flag
			emit("item-selected", item, shouldAutoAdd)
			itemStore.clearSearch()

			if (shouldAutoAdd) {
				toast.create({
					title: "✓ Auto-Added",
					text: `${item.item_name} added to cart`,
					icon: "check",
					iconClasses: "text-blue-600",
				})
			} else {
				toast.create({
					title: "Item Added",
					text: `${item.item_name} added to cart`,
					icon: "check",
					iconClasses: "text-green-600",
				})
			}
			return
		}
	} catch (error) {
		console.error("Barcode API error:", error)
	}

	// Fallback: If only one item matches in filtered results, auto-select it
	if (filteredItems.value.length === 1) {
		emit("item-selected", filteredItems.value[0], shouldAutoAdd)
		itemStore.clearSearch()

		if (shouldAutoAdd) {
			toast.create({
				title: "✓ Auto-Added",
				text: `${filteredItems.value[0].item_name} added to cart`,
				icon: "check",
				iconClasses: "text-blue-600",
			})
		} else {
			toast.create({
				title: "Item Added",
				text: `${filteredItems.value[0].item_name} added to cart`,
				icon: "check",
				iconClasses: "text-green-600",
			})
		}
	} else if (filteredItems.value.length === 0) {
		toast.create({
			title: "Item Not Found",
			text: `No item found with barcode: ${barcode}`,
			icon: "alert-circle",
			iconClasses: "text-red-600",
		})

		// If scanner mode is enabled, clear search immediately for next scan
		if (shouldAutoAdd) {
			itemStore.clearSearch()
		}
	} else {
		if (shouldAutoAdd) {
			// In scanner mode, don't show manual selection - just notify
			toast.create({
				title: "Multiple Items Found",
				text: `${filteredItems.value.length} items match barcode. Please refine search.`,
				icon: "alert-circle",
				iconClasses: "text-orange-600",
			})
		} else {
			toast.create({
				title: "Multiple Items Found",
				text: `${filteredItems.value.length} items match. Please select one.`,
				icon: "alert-circle",
				iconClasses: "text-blue-600",
			})
		}
	}
}

function toggleBarcodeScanner() {
	scannerEnabled.value = !scannerEnabled.value

	// Disable auto-add when scanner is disabled
	if (!scannerEnabled.value) {
		autoAddEnabled.value = false
	}

	// Focus on search input when enabling scanner
	if (scannerEnabled.value) {
		const input = searchInputRef.value || document.getElementById("item-search")
		if (input) {
			input.focus()
		}

		toast.create({
			title: "Barcode Scanner Enabled",
			text: "Click 'Auto' button to automatically add items when you press Enter",
			icon: "check",
			iconClasses: "text-green-600",
		})
	} else {
		toast.create({
			title: "Barcode Scanner Disabled",
			text: "Scanner mode turned off",
			icon: "alert-circle",
			iconClasses: "text-gray-600",
		})
	}
}

function toggleAutoAdd() {
	// Auto-add works independently - no need for scanner mode
	autoAddEnabled.value = !autoAddEnabled.value

	// Auto-enable scanner mode when auto-add is enabled
	if (autoAddEnabled.value && !scannerEnabled.value) {
		scannerEnabled.value = true
	}

	// Clear any pending timer when toggling off
	if (!autoAddEnabled.value && autoSearchTimer.value) {
		clearTimeout(autoSearchTimer.value)
		autoSearchTimer.value = null
	}

	if (autoAddEnabled.value) {
		toast.create({
			title: "Auto-Add Enabled",
			text: "Type or scan barcode - items will be added automatically after 0.5s",
			icon: "check",
			iconClasses: "text-blue-600",
		})

		// Focus on search input
		const input = searchInputRef.value || document.getElementById("item-search")
		if (input) {
			input.focus()
		}
	} else {
		toast.create({
			title: "Auto-Add Disabled",
			text: "Items will require manual selection",
			icon: "alert-circle",
			iconClasses: "text-gray-600",
		})
	}
}

function formatCurrency(amount) {
	return formatCurrencyUtil(Number.parseFloat(amount || 0), props.currency)
}

// Expose methods for parent component
defineExpose({
	loadItems: () => itemStore.loadAllItems(props.posProfile),
	loadItemGroups: () => itemStore.loadItemGroups(),
	loadMoreItems: () => itemStore.loadMoreItems(),
})

// View mode functions
function setViewMode(mode) {
	viewMode.value = mode
	userManuallySetView.value = true
}

// Pagination functions
function goToPage(page) {
	if (page >= 1 && page <= totalPages.value) {
		currentPage.value = page
	}
}

function nextPage() {
	if (currentPage.value < totalPages.value) {
		currentPage.value++
	}
}

function previousPage() {
	if (currentPage.value > 1) {
		currentPage.value--
	}
}

function getPaginationRange() {
	const range = []
	const total = totalPages.value
	const current = currentPage.value
	const delta = 2 // Number of pages to show on each side of current page

	if (total <= 7) {
		// Show all pages if total is small
		for (let i = 1; i <= total; i++) {
			range.push(i)
		}
	} else {
		// Show smart range with ellipsis
		if (current <= 3) {
			for (let i = 1; i <= 5; i++) {
				range.push(i)
			}
		} else if (current >= total - 2) {
			for (let i = total - 4; i <= total; i++) {
				range.push(i)
			}
		} else {
			for (let i = current - delta; i <= current + delta; i++) {
				range.push(i)
			}
		}
	}

	return range
}

// Get stock status based on quantity
function getStockStatus(qty) {
	const quantity = Math.floor(qty || 0)
	const lowStockThreshold = 10 // Items with 10 or less are considered low stock

	if (quantity <= 0) {
		return {
			level: "out",
			color: "bg-red-500",
			textColor: "text-white",
			label: "Out of Stock",
		}
	} else if (quantity <= lowStockThreshold) {
		return {
			level: "low",
			color: "bg-amber-500",
			textColor: "text-white",
			label: "Low Stock",
		}
	} else {
		return {
			level: "safe",
			color: "bg-green-500",
			textColor: "text-white",
			label: "In Stock",
		}
	}
}
</script>

<style scoped>
/* Hide scrollbar for Chrome, Safari and Opera */
.scrollbar-hide::-webkit-scrollbar {
    display: none;
}

/* Hide scrollbar for IE, Edge and Firefox */
.scrollbar-hide {
    -ms-overflow-style: none;  /* IE and Edge */
    scrollbar-width: none;  /* Firefox */
}

/* Performance optimizations for low-end devices */
[class*="grid-cols-"] > div {
	/* Tell browser which properties will change */
	will-change: opacity;
	/* Use GPU acceleration for transforms */
	transform: translateZ(0);
	/* Optimize for speed over quality */
	backface-visibility: hidden;
}

/* Optimize scroll containers */
.overflow-y-auto, .overflow-x-auto {
	/* Enable smooth scrolling with GPU acceleration */
	-webkit-overflow-scrolling: touch;
	/* Create stacking context for better compositing */
	transform: translateZ(0);
	will-change: scroll-position;
}

/* Reduce paint areas */
.relative {
	/* Isolate paint regions */
	isolation: isolate;
}

/* Optimize images */
img {
	/* Use browser's image optimization */
	image-rendering: -webkit-optimize-contrast;
	image-rendering: crisp-edges;
}
</style>
